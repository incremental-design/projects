name: Only allow fast-forward merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce-rebase:
    name: Enforce Rebase Requirement
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if branch is rebased
        run: |
          # Exit at first failure
          set -e

          # Get the target branch (base of the PR)
          TARGET_BRANCH="${{ github.base_ref }}"
          FEATURE_BRANCH="${{ github.head_ref }}"

          echo "============================================================"
          echo "üîç Checking rebase requirement"
          echo "üì• Target branch: $TARGET_BRANCH"
          echo "üåø Feature branch: $FEATURE_BRANCH"
          echo "============================================================"

          # Get the HEAD of the target branch
          TARGET_HEAD=$(git rev-parse "origin/$TARGET_BRANCH")
          echo "üéØ Target branch HEAD: $TARGET_HEAD"

          # Get the merge base between feature branch and target branch
          MERGE_BASE=$(git merge-base "origin/$FEATURE_BRANCH" "origin/$TARGET_BRANCH")
          echo "üîó Merge base: $MERGE_BASE"

          # Compare them
          if [[ "$TARGET_HEAD" == "$MERGE_BASE" ]]; then
            echo ""
            echo "‚úÖ SUCCESS: $FEATURE_BRANCH can be merged into $TARGET_BRANCH"
          else
            echo ""
            echo "‚ùå FAILURE: $FEATURE_BRANCH needs to be rebased onto $TARGET_BRANCH before it can be merged into it"
            echo ""
            echo "The feature branch is not up-to-date with the target branch."
            echo "Before merging, please rebase your feature branch:"
            echo ""
            echo "  git checkout $FEATURE_BRANCH"
            echo "  git fetch origin"
            echo "  git rebase origin/$TARGET_BRANCH"
            echo "  git push --force-with-lease"
            echo ""
            echo "This ensures a clean linear history without merge commits."
            exit 1
          fi
