name: Tag Main

# Tag Main Pipeline Flow:
#
# This workflow iterates through commits from
# merge base to HEAD. for each commit, it detects
# projects that have a semver bump, collects all tags,
# then creates and pushes them atomically.

on:
  push:
    branches: [main-temp]

jobs:
  tag-main:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.collect-tags.outputs.tags }}
    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Build recurse.nix script with no steps
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '[]'

      - name: Collect tags and create them atomically
        id: collect-tags
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          nix-shell -p direnv --run '
            # Exit at first failure
            set -e

            # Function to check if a project should be released
            should_release() {
              local sha="$1"
              # Read from project-lint-semver output with null-byte delimiter
              local semver
              local bump_flag
              IFS=$'\0' read -r semver bump_flag < <(project-lint-semver "false" "$sha")

              if [ -z "$semver" ] || [ -z "$bump_flag" ]; then
                echo "‚ùå Failed to parse project-lint-semver output" >&2
                return 1
              fi

              if (( bump_flag <= 0 )) || [ "$semver" = "0.0.0" ]; then
                return 0
              fi

              # calculate tag
              local project_name=$(git rev-parse --prefix)
              local tag_name="${project_name}/v${semver}"

              # Output tag name
              echo "$tag_name"

              return 0
            }

            echo "============================================================"
            echo "üîç Processing projects from merge base to HEAD: ${{ github.sha }}"
            echo "============================================================"

            # Get the commit before this push to compare against
            MERGE_BASE=${{ github.event.before }}
            echo "üìç Merge base: $MERGE_BASE"

            # Get all commits from merge base to HEAD
            COMMITS=$(git rev-list --reverse $MERGE_BASE..HEAD)

            # Handle empty commit range
            if [[ -z "$COMMITS" ]]; then
              echo "‚ÑπÔ∏è No commits to process between merge base and HEAD"
              exit 0
            fi

            # Array to collect all tags to create
            declare -a TAGS_TO_CREATE=()

            # Loop through each commit
            for commit in $COMMITS; do
              echo "============================================================"
              echo "üîç Processing commit: $commit"
              echo "üìù Message: $(git log -1 --pretty=%B $commit)"
              echo "üìÖ Date: $(git log -1 --pretty=%ad --date=iso $commit)"
              echo "üßë‚Äçüíª Author: $(git log -1 --pretty=%an $commit)"
              echo "============================================================"

              # Check out this specific commit
              git checkout -q $commit

              # Run recurse and process directories
              echo "üèÉ Running recurse for commit $commit..."

              # Collect directories into array
              mapfile -t -d $'\0' directories < <(./result/bin/recurse false 2>/dev/null)

              # Process each directory
              for directory in "${directories[@]}"; do
                echo "üìÅ Processing directory: $directory"

                cd "$directory"
                direnv allow

                # Check if this project should be released
                if tag_name=$(should_release "$commit"); then
                  if tag_output=$(git tag "$tag_name" "$commit" 2>&1); then
                    TAGS_TO_CREATE+=("$tag_name")
                    echo "  üìå Collected tag: $tag_name"
                  else
                    # If tag creation failed, check if it already exists (idempotent)
                    if git rev-parse "$tag_name" &>/dev/null; then
                      echo "  ‚ÑπÔ∏è  Tag already exists: $tag_name"
                    else
                      echo "  ‚ùå Failed to create tag $tag_name: $tag_output" >&2
                      exit 1
                    fi
                  fi
                fi
              done

              echo "‚úÖ Commit $commit processed successfully"
              echo ""
            done

            # Return to the original branch/commit
            git checkout -q ${{ github.sha }}

            # Clean up nix result
            if [ -L result ]; then
              unlink result
            fi

            # Push all tags at once if any were collected
            if [ ${#TAGS_TO_CREATE[@]} -gt 0 ]; then
              echo "============================================================"
              echo "üì§ Pushing all tags to origin..."
              echo "============================================================"

              git push origin "${TAGS_TO_CREATE[@]}"
              echo "‚úÖ All tags pushed successfully"
            else
              echo "‚ÑπÔ∏è No tags to create"
            fi

            echo "‚úÖ All tags processed successfully"
          '
