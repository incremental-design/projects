# Validate each commit in a push to ensure every commit maintains a working state
# across all supported platforms

name: Validate Commits on Push

# CI Pipeline Flow:
#
# This workflow validates each commit from base to head individually
# to ensure each commit maintains a working state:
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Per-Commit Sequential Validation                         â”‚
# â”‚                                                          â”‚
# â”‚  For each commit C1...CN:                                â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
# â”‚  â”‚   git checkout  â”‚   â”‚  Run validation â”‚   â”‚  Next  â”‚  â”‚
# â”‚  â”‚    commit Ci    â”œâ”€â”€â–ºâ”‚     step(s)     â”œâ”€â”€â–ºâ”‚ commit â”‚  â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Workflow Steps:
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Commits    â”‚ <-- Run on Linux ARM
# â”‚    Messages      â”‚     Validates commit message format
# â”‚                  â”‚     for each commit in sequence
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Semantic   â”‚ <-- Run on Linux ARM
# â”‚    Version       â”‚     Validates semantic version tags
# â”‚                  â”‚     for each project
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Projects   â”‚ <-- Run on Linux ARM
# â”‚                  â”‚     Each commit is checked out and
# â”‚                  â”‚     all projects are linted
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#          â”‚     Build & Test (parallel across platforms)
#          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#          â”‚    â”‚  Each commit is checked out and validated     â”‚
#          â”‚    â”‚  on every platform in parallel                â”‚
#          â”‚    â”‚                                               â”‚
#          â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
#          â”‚    â”‚  â”‚ macOS ARM64     â”‚   â”‚ macOS x86_64    â”‚    â”‚
#          â”‚    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
#          â”‚    â”‚  â”‚ â”‚    Build    â”‚ â”‚   â”‚ â”‚    Build    â”‚ â”‚    â”‚
#          â””â”€â”€â”€â”€â”¼â”€â–ºâ”‚ â”‚    Test     â”‚ â”‚   â”‚ â”‚    Test     â”‚ â”‚    â”‚
#               â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
#               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
#               â”‚                                               â”‚
#               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
#               â”‚  â”‚ Linux ARM64     â”‚   â”‚ Linux x86_64    â”‚    â”‚
#               â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
#               â”‚  â”‚ â”‚    Build    â”‚ â”‚   â”‚ â”‚    Build    â”‚ â”‚    â”‚
#               â”‚  â”‚ â”‚    Test     â”‚ â”‚   â”‚ â”‚    Test     â”‚ â”‚    â”‚
#               â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
#               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
#               â”‚                                               â”‚
#               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                      â”‚
#                                      â”‚
#                                      â–¼
#                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                             â”‚                  â”‚
#                             â”‚  Summary Report  â”‚
#                             â”‚                  â”‚
#                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  push:
    branches:
      - "**" # Run on all branches
  pull_request:
    branches: ["main"]

jobs:
  # First job: Gather the commits that need validation
  lint-commit-messages:
    name: Lint Commit Messages
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build lintCommit from Nix
        run: |
          # Build the lintCommit tool from the Nix expression
          nix-build .config/lintCommit.nix

      - name: Lint Commit Messages
        id: lint-commit-messages
        run: |
          # Exit at first failure
          set -e

          # Get all commits in this push (works for any branch)
          # Handle edge case where before is all zeros (new repo/branch)
          if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            # First push to new branch - get commits since branching from default branch
            COMMITS=$(git rev-list origin/${{ github.event.repository.default_branch }}..${{ github.event.after }})
          else
            # Normal case - get commits in the range
            COMMITS=$(git rev-list ${{ github.event.before }}..${{ github.event.after }})
          fi

          # Handle empty pushes
          if [[ -z "$COMMITS" ]]; then
            echo "No commits to validate"
            exit 0
          fi

          # Format for logging
          COMMITS_JSON=$(echo "$COMMITS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Found commits to validate: $COMMITS_JSON"

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Validating commit: $commit"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "============================================================"

            # Get commit message and validate it using lintCommit
            git log -1 --pretty=%B "$commit" > commit_message.txt
            ./result/bin/lintCommit commit_message.txt

            echo "âœ… Commit $commit passed validation"
            echo ""
          done

  # Lint job - only needs to run on one platform since it's not platform-specific
  lint-semantic-version:
    name: Lint Semantic Version
    needs: lint-commit-messages
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build recurse.nix script with lintSemVer step only
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["lintSemVer"]'

      - name: Lint semantic versions
        run: |
          # Exit at first failure
          set -e

          echo "============================================================"
          echo "ğŸ” Linting semantic versions from latest commit"
          echo "============================================================"

          # Run the recurse script which will lint semantic versions
          echo "ğŸ” Running semantic version lint..."
          ./result/bin/recurse

          echo "âœ… Semantic version linting passed"

  lint-projects:
    name: Lint Projects
    needs: lint-semantic-version
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build recurse.nix script with lint step only
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["lint"]'

      - name: Lint each commit
        run: |
          # Exit at first failure
          set -e

          # Get all commits in this push (works for any branch)
          # Handle edge case where before is all zeros (new repo/branch)
          if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            # First push to new branch - get commits since branching from default branch
            COMMITS=$(git rev-list origin/${{ github.event.repository.default_branch }}..${{ github.event.after }})
          else
            # Normal case - get commits in the range
            COMMITS=$(git rev-list ${{ github.event.before }}..${{ github.event.after }})
          fi

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Linting commit: $commit"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "ğŸ“… Date: $(git log -1 --pretty=%ad --date=iso $commit)"
            echo "ğŸ§‘â€ğŸ’» Author: $(git log -1 --pretty=%an $commit)"
            echo "============================================================"

            # Check out this specific commit
            git checkout -q $commit

            # Run the recurse script which will lint
            echo "ğŸ” Running lint on projects..."
            ./result/bin/recurse

            echo "âœ… Commit $commit passed project linting"
            echo ""
          done

          # Return to the original branch/commit
          git checkout -q ${{ github.sha }}

  # Build and test job - needs to run on all platforms
  build-test:
    name: Build & test on ${{ matrix.os-name }} (${{ matrix.platform }})
    needs: lint-projects

    strategy:
      matrix:
        include:
          - os: macos-14
            os-name: macOS
            platform: aarch64-darwin
          - os: macos-13
            os-name: macOS
            platform: x86_64-darwin
          - os: ubuntu-22.04
            os-name: Linux
            platform: x86_64-linux
          # For ARM Linux, using GitHub-hosted runner
          - os: ubuntu-22.04-arm
            os-name: Linux
            platform: aarch64-linux

      # Don't cancel other platform runs if one fails
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build recurse.nix script with build and test steps
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["build" "runTest"]'

      - name: Build and test each commit
        run: |
          # Exit at first failure
          set -e

          # Determine which commits to validate (same logic as in lint-commit-messages job)
          if [[ "${{ github.ref }}" != "refs/heads/${{ github.event.repository.default_branch }}" ]]; then
            COMMITS=$(git rev-list "$(git merge-base origin/${{ github.event.repository.default_branch }} HEAD)"..HEAD)
          else
            COMMITS=$(git rev-list HEAD^..HEAD)
          fi

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Validating commit: $commit on ${{ matrix.os-name }} (${{ matrix.platform }})"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "ğŸ“… Date: $(git log -1 --pretty=%ad --date=iso $commit)"
            echo "ğŸ§‘â€ğŸ’» Author: $(git log -1 --pretty=%an $commit)"
            echo "============================================================"

            # Check out this specific commit
            git checkout -q $commit

            # Run the recurse script which will build and test
            echo "ğŸ—ï¸ Running build and test on ${{ matrix.platform }}..."
            ./result/bin/recurse

            echo "âœ… Commit $commit passed build and test on ${{ matrix.os-name }} (${{ matrix.platform }})"
            echo ""
          done

          # Return to the original branch/commit
          git checkout -q ${{ github.sha }}

  # Final job to report success after all validations pass
  validation-summary:
    name: Validation Summary
    needs: [lint-commit-messages, lint-projects, build-test]
    runs-on: ubuntu-22.04
    steps:
      - name: Report Success
        run: |
          echo "============================================================"
          echo "âœ… All commits have been validated successfully!"
          echo "   âœ“ Commit messages validated on aarch64-linux"
          echo "   âœ“ Project linting passed on aarch64-linux"
          echo "   âœ“ Build and test passed on all platforms:"
          echo "     - aarch64-darwin (macOS ARM)"
          echo "     - x86_64-darwin (macOS Intel)"
          echo "     - x86_64-linux (Linux x86)"
          echo "     - aarch64-linux (Linux ARM)"
          echo "   âœ“ Publish dry run succeeded on aarch64-linux"
          echo "============================================================"
