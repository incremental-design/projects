# Validate each commit in a push to ensure every commit maintains a working state
# across all supported platforms

name: Validate Commits on Push

# CI Pipeline Flow:
#
# This workflow validates each commit from base to head individually
# to ensure each commit maintains a working state:
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Per-Commit Sequential Validation                         â”‚
# â”‚                                                          â”‚
# â”‚  For each commit C1...CN:                                â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
# â”‚  â”‚   git checkout  â”‚   â”‚  Run validation â”‚   â”‚  Next  â”‚  â”‚
# â”‚  â”‚    commit Ci    â”œâ”€â”€â–ºâ”‚     step(s)     â”œâ”€â”€â–ºâ”‚ commit â”‚  â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Workflow Steps:
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Commits    â”‚ <-- Run on Linux ARM
# â”‚    Messages      â”‚     Validates commit message format
# â”‚                  â”‚     for each commit in sequence
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Semantic   â”‚ <-- Run on Linux ARM
# â”‚    Versions      â”‚     Validates semver in each project
# â”‚                  â”‚     for each commit in sequence
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  â”‚
# â”‚  Lint Projects   â”‚ <-- Run on Linux ARM
# â”‚                  â”‚     Each commit is checked out and
# â”‚                  â”‚     all projects are linted
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
#          â–¼
#          â”‚     Build & Test (parallel across platforms)
#          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#          â”‚    â”‚  Each commit is checked out and validated     â”‚
#          â”‚    â”‚  on every platform in parallel                â”‚
#          â”‚    â”‚                                               â”‚
#          â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
#          â”‚    â”‚  â”‚ macOS ARM64     â”‚                          â”‚
#          â”‚    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                          â”‚
#          â”‚    â”‚  â”‚ â”‚    Build    â”‚ â”‚                          â”‚
#          â””â”€â”€â”€â”€â”¼â”€â–ºâ”‚ â”‚    Test     â”‚ â”‚                          â”‚
#               â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                          â”‚
#               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
#               â”‚                                               â”‚
#               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
#               â”‚  â”‚ Linux ARM64     â”‚   â”‚ Linux x86_64    â”‚    â”‚
#               â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
#               â”‚  â”‚ â”‚    Build    â”‚ â”‚   â”‚ â”‚    Build    â”‚ â”‚    â”‚
#               â”‚  â”‚ â”‚    Test     â”‚ â”‚   â”‚ â”‚    Test     â”‚ â”‚    â”‚
#               â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
#               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
#               â”‚                                               â”‚
#               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                      â”‚
#                                      â”‚
#                                      â–¼
#                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                             â”‚                  â”‚
#                             â”‚  Summary Report  â”‚
#                             â”‚                  â”‚
#                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

on:
  push:
    branches:
      - "**" # Run on all branches
  pull_request:
    branches: ["main"]

jobs:
  # First job: Gather the commits that need validation
  lint-commit-messages:
    name: Lint Commit Messages
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: DeterminateSystems/nix-installer-action@main

      - name: Build lintCommit from Nix
        run: |
          # Build the lintCommit tool from the Nix expression
          nix-build .config/lintCommit.nix

      - name: Lint Commit Messages
        id: lint-commit-messages
        run: |
          # Exit at first failure
          set -e

          # Get all commits from GitHub event
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '(. // []) | .[].id')

          # Handle empty pushes
          if [[ -z "$COMMITS" ]]; then
            echo "No commits to validate"
            exit 0
          fi

          # Format for logging
          COMMITS_JSON=$(echo "$COMMITS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Found commits to validate: $COMMITS_JSON"

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Validating commit: $commit"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "============================================================"

            # Get commit message and validate it using lintCommit
            git log -1 --pretty=%B "$commit" > commit_message.txt
            ./result/bin/lintCommit commit_message.txt

            echo "âœ… Commit $commit passed validation"
            echo ""
          done

  # Semantic version validation job
  lint-semantic-versions:
    name: Lint Semantic Versions
    needs: lint-commit-messages
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    steps:
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build recurse.nix script with project-lint-semver step only
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["project-lint-semver"]'

      - name: Lint semantic versions for each commit
        run: |
          # Exit at first failure
          set -e

          # we have to lint semantic versions at EVERY commit in a push
          # to ensure that projects that were DELETED between base and
          # HEAD have valid semantic versions

          # Get all commits from GitHub event
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[].id')

          # Handle empty pushes
          if [[ -z "$COMMITS" ]]; then
            echo "No commits to validate"
            exit 0
          fi

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Linting semantic versions: $commit"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "ğŸ“… Date: $(git log -1 --pretty=%ad --date=iso $commit)"
            echo "ğŸ§‘â€ğŸ’» Author: $(git log -1 --pretty=%an $commit)"
            echo "============================================================"

            # Check out this specific commit
            git checkout -q $commit

            # Run the recurse script which will lint semantic versions
            echo "ğŸ” Running semantic version validation on projects..."
            temp_stderr=$(mktemp)
            ./result/bin/recurse 2>"$temp_stderr"
            exit_code=$?
            while IFS= read -r line; do
              echo "        $line" >&2
            done < "$temp_stderr"
            rm "$temp_stderr"
            if [ $exit_code -ne 0 ]; then exit $exit_code; fi

            echo "âœ… Commit $commit passed semantic version validation"
            echo ""
          done

          # Return to the original branch/commit
          git checkout -q ${{ github.sha }}

  # Lint job - only needs to run on one platform since it's not platform-specific
  lint-projects:
    name: Lint Projects
    needs: lint-semantic-versions
    runs-on: ubuntu-22.04-arm # GitHub-hosted ARM64 runner
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: DeterminateSystems/nix-installer-action@main

      - name: Build recurse.nix script with project-lint step only
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["project-lint"]'

      - name: Lint each commit
        run: |
          # Exit at first failure
          set -e

          # Get all commits from GitHub event
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '(. // []) | .[].id')

          # Handle empty pushes
          if [[ -z "$COMMITS" ]]; then
            echo "No commits to validate"
            exit 0
          fi

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Linting commit: $commit"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "ğŸ“… Date: $(git log -1 --pretty=%ad --date=iso $commit)"
            echo "ğŸ§‘â€ğŸ’» Author: $(git log -1 --pretty=%an $commit)"
            echo "============================================================"

            # Check out this specific commit
            git checkout -q $commit

            # Run the recurse script which will lint
            echo "ğŸ” Running lint on projects..."
            temp_stderr=$(mktemp)
            ./result/bin/recurse 2>"$temp_stderr"
            exit_code=$?
            while IFS= read -r line; do
              echo "        $line" >&2
            done < "$temp_stderr"
            rm "$temp_stderr"
            if [ $exit_code -ne 0 ]; then exit $exit_code; fi

            echo "âœ… Commit $commit passed project linting"
            echo ""
          done

          # Return to the original branch/commit
          git checkout -q ${{ github.sha }}

  # Build and test job - needs to run on all platforms
  build-test:
    name: Build & test on ${{ matrix.os-name }} (${{ matrix.platform }})
    needs: lint-projects

    strategy:
      matrix:
        include:
          - os: macos-14
            os-name: macOS
            platform: aarch64-darwin
          - os: ubuntu-22.04
            os-name: Linux
            platform: x86_64-linux
          - os: ubuntu-22.04-arm
            os-name: Linux
            platform: aarch64-linux

      # Don't cancel other platform runs if one fails
      fail-fast: false

    runs-on: ${{ matrix.os }}
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: DeterminateSystems/nix-installer-action@main

      - name: Build recurse.nix script with project-build and project-test steps
        run: |
          # Get nixpkgs directly from flake inputs
          nix-build .config/recurse.nix --arg pkgs "import (builtins.getFlake \"path:$(pwd)\").inputs.nixpkgs {}" --arg steps '["project-build" "project-test"]'

      - name: Build and test each commit
        run: |
          # Exit at first failure
          set -e

          # Get all commits from GitHub event
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '(. // []) | .[].id')

          # Handle empty pushes
          if [[ -z "$COMMITS" ]]; then
            echo "No commits to validate"
            exit 0
          fi

          # Loop through each commit
          for commit in $COMMITS; do
            echo "============================================================"
            echo "ğŸ” Validating commit: $commit on ${{ matrix.os-name }} (${{ matrix.platform }})"
            echo "ğŸ“ Message: $(git log -1 --pretty=%B $commit)"
            echo "ğŸ“… Date: $(git log -1 --pretty=%ad --date=iso $commit)"
            echo "ğŸ§‘â€ğŸ’» Author: $(git log -1 --pretty=%an $commit)"
            echo "============================================================"

            # Check out this specific commit
            git checkout -q $commit

            # Run the recurse script which will build and test
            echo "ğŸ—ï¸ Running build and test on ${{ matrix.platform }}..."
            temp_stderr=$(mktemp)
            ./result/bin/recurse 2>"$temp_stderr"
            exit_code=$?
            while IFS= read -r line; do
              echo "        $line" >&2
            done < "$temp_stderr"
            rm "$temp_stderr"
            if [ $exit_code -ne 0 ]; then exit $exit_code; fi

            echo "âœ… Commit $commit passed build and test on ${{ matrix.os-name }} (${{ matrix.platform }})"
            echo ""
          done

          # Return to the original branch/commit
          git checkout -q ${{ github.sha }}
